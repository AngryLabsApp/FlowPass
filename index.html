<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlowPass — Usuarios</title>
  <link rel="icon" href="/public/icons/logo-flowpass.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@700;800&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="./public/css/index.css" />
</head>

<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar"></aside>

    <!-- Content -->
    <!-- Content -->
    <div class="content">
      <div class="topbar">
        <!-- Filtros -->
        <div class="topbar__filters">
          <input id="searchInput" class="topbar__search-input" type="text" placeholder="Buscar por nombre o email…"
            aria-label="Buscar por nombre o email…" />

          <select id="statusSelect" class="topbar__select" aria-label="Filtrar por estado">
            <option value="">Estado: Todos</option>
            <option value="Activo">Activo</option>
            <option value="Inactivo">Inactivo</option>
            <option value="Pausado">Pausado</option>
          </select>
          <!--       
      <select id="methodSelect" class="topbar__select" aria-label="Filtrar por método de pago">
        <option value="">Método: Todos</option>
        <option value="Tarjeta">Tarjeta</option>
        <option value="Efectivo">Efectivo</option>
        <option value="Transferencia">Transferencia</option>
      </select>
 -->
        </div>

        <!-- Acción principal -->
        <div class="topbar__actions">
          <button id="nuevoUsuario" class="btn btn--primary">
            Nuevo usuario
            <svg class="icon button__icon">
              <use href="/public/icons/sprites.svg#plus"></use>
            </svg>
          </button>
        </div>
      </div>

      <main class="main">
        <h1 class="main__title">Usuarios</h1>
        <div class="card" aria-label="Tabla de usuarios">
          <table class="table">
            <thead class="table__head" id="usersThead">
              <tr class="table__row">
                <th class="table__head-cell table__col--first-name">
                  Nombre(s)
                </th>
                <th class="table__head-cell table__col--last-name">
                  Apellido(s)
                </th>
                <th class="table__head-cell table__col--plan">Plan</th>
                <th class="table__head-cell table__col--classes">
                  Clases realizadas
                </th>
                <th class="table__head-cell table__col--grace">
                  Días de cortesía
                </th>
                <th class="table__head-cell table__col--start">
                  Inicio de plan
                </th>
                <th class="table__head-cell table__col--end">Fin de plan</th>
                <th class="table__head-cell table__col--status">Estado</th>
                <th class="table__head-cell table__col--status">
                  Estatus de pago
                </th>
              </tr>
            </thead>
            <tbody class="table__body" id="usersTbody"></tbody>
          </table>
          <div class="table__footer" id="usersPager">
            <div class="pagination">
              <div class="pagination__status" id="pagerStatus"></div>
              <nav class="pagination__nav" aria-label="Paginación" id="pagination"></nav>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal: Ficha de usuario -->
  <div class="modal" id="userModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
    <div class="modal__overlay" data-close></div>

    <div class="modal__dialog card" role="document">
      <!-- Header -->
      <header class="modal__header">
        <h2 class="modal__title">
          <span id="userModalTitle">Ficha del usuario</span>

          <div class="modal__tag--principal hidden">
            Principal
          </div>

          <span id="userPartnerChip" class="badge badge--info badge--flex hidden">
            <svg class="icon" aria-hidden="true">
              <use href="/public/icons/sprites.svg#pair"></use>
            </svg>
            <span id="userPartnerChipText" class="chip-text"></span>
          </span>

          <span id="checkInStatusChip" class="badge badge--pending badge--flex hidden">
            <svg class="icon" aria-hidden="true">
              <use href="/public/icons/sprites.svg#warn"></use>
            </svg>
            <span class="chip-text-pareja" id="checkInStatusChipText"></span>
          </span>
        </h2>
        <button class="modal__close" type="button" aria-label="Cerrar" data-close>
          ✕
        </button>
      </header>

      <div class="modal__body">
        <!-- Panel principal -->
        <div class="modal__main">
          <!-- Sección: Plan -->
          <section class="section" id="userPlanSection">
            <h3 class="section__title">Plan actual</h3>
            <div class="info-grid">
              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#user-plan"></use>
                  </svg>Plan
                </div>
                <div class="value" data-field="UserPlan">—</div>
              </div>
              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#class-icon"></use>
                  </svg>
                  Clases realizadas
                  <button class="edit-btn" aria-label="Editar" id="btn-edit-clases">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value" data-field="NumberOfClases">—</div>
              </div>

              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#user-status"></use>
                  </svg>
                  Estado
                  <button class="edit-btn" aria-label="Editar" id="btn-edit-status">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value value--editable">
                  <span class="value__content" data-field="PlanStatus">—</span>
                </div>
              </div>
              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#calendar"></use>
                  </svg>
                  Inicio del plan
                  <button class="edit-btn" aria-label="Editar" id="btn-edit-fecha_inicio_plan">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value" data-field="DateOfSubcription">—</div>
              </div>
              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#calendar-payday"></use>
                  </svg>
                  Próximo pago
                </div>
                <div class="value" data-field="NextPaymentDay">—</div>
              </div>

              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#gift"></use>
                  </svg>
                  Días de cortesía
                </div>
                <div class="value" data-field="FreeDays">—</div>
              </div>
            </div>
          </section>
          <!-- Sección: Datos personales -->
          <section class="section" id="userPersonalDataSection">
            <h3 class="section__title">Datos personales</h3>
            <div class="info-grid">
              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#user-code"></use>
                  </svg>
                  Codigo de ingreso
                </div>
                <div class="value value--inline">
                  <span class="value__content" data-field="UserCode">-</span>
                  <button class="btn btn--whatsapp" id="btnSendCodeWhatsApp" type="button">
                    <svg class="icon icon--sm">
                      <use href="/public/icons/sprites.svg#whatsapp"></use>
                    </svg>
                    Enviar Codigo
                  </button>
                </div>
              </div>

              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#user-id-card"></use>
                  </svg>
                  DNI/Pasaporte/CE
                   <button class="edit-btn" aria-label="Editar identificacion" id="btn-edit-identificacion">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value" data-field="UserIdentificationNumber">
                  —
                </div>
              </div>

              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#phone"></use>
                  </svg>
                  Teléfono
                  <button class="edit-btn" aria-label="Editar teléfono" id="btn-edit-phone">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value value--editable">
                  <span class="value__content" data-field="UserPhone">—</span>
                </div>
              </div>

              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#mail"></use>
                  </svg>
                  Email
                  <button class="edit-btn" aria-label="Editar email" id="btn-edit-email">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value value--editable">
                  <span class="value__content" data-field="UserEmail">—</span>
                </div>
              </div>

              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#home"></use>
                  </svg>
                  Dirección
                  <button class="edit-btn" aria-label="Editar dirección" id="btn-edit-direccion">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value value--editable">
                  <span class="value__content" data-field="UserAddress">—</span>
                </div>
              </div>

              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#birthday"></use>
                  </svg>
                  Cumpleaños
                  <button class="edit-btn" aria-label="Editar cumpleanos" id="btn-edit-cumpleanos">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value" data-field="UserBirthday">—</div>
              </div>
              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#notify-icon"></use>
                  </svg>
                  Notificar
                  <button class="edit-btn" aria-label="Editar nofity" id="btn-edit-notify">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value value--editable">
                  <span class="value__content" data-field="UserNotificar">—</span>
                </div>
              </div>

              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#hospital"></use>
                  </svg>
                  Enfermedad / Patología
                  <button class="edit-btn" aria-label="Editar patoligias" id="btn-edit-patologias">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>

                <div class="value value--editable">
                  <span class="value__content" data-field="UserPatologias">—</span>
                </div>
              </div>

              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#airplane"></use>
                  </svg>
                  ¿Está de viaje?
                  <button class="edit-btn" aria-label="Editar viaje" id="btn-edit-viaje">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>

                <div class="value value--editable">
                  <span class="value__content" data-field="UserIsOnTravel">—</span>
                </div>
              </div>

              <!-- <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#user-id"></use>
                  </svg>Flowpass ID
                </div>
                <div class="value" data-field="UserID">—</div>
              </div>
            </div> -->
          </section>

          <!-- Sección: Clases y Fechas -->
          <section class="section" id="userPaymentSection">
            <h3 class="section__title">Detalle del ultimo pago</h3>
            <div class="info-grid">
              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#money-hand"></use>
                  </svg>Método de pago
                </div>
                <div class="value" data-field="PaymentMethod">—</div>
              </div>
              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#money"></use>
                  </svg>Monto
                </div>
                <div class="value" data-field="PaymentAmount">—</div>
              </div>
              <div class="row">
                <div class="label">
                  <svg class="icon">
                    <use href="/public/icons/sprites.svg#user-status"></use>
                  </svg>Estado del Pago
                  <button class="edit-btn" aria-label="Editar Estado del pago" id="btn-edit-estado_pago">
                    <svg class="icon icon-rose">
                      <use href="/public/icons/sprites.svg#edit"></use>
                    </svg>
                  </button>
                </div>
                <div class="value" data-field="PaymentStatus">—</div>
              </div>
            </div>
          </section>

          <!-- Acciones -->
          <div class="modal__actions">
            <button class="btn btn--primary" id="btnCheckIn">
              Registrar ingreso
            </button>
            <button class="btn btn--secondary" id="btnToggleForm" aria-expanded="false" aria-controls="updateForm">
              Renovar plan
              <svg class="icon">
                <use href="/public/icons/sprites.svg#arrow-right"></use>
              </svg>
            </button>
          </div>
        </div>

        <!-- Formulario de actualización (inicialmente oculto) -->
        <aside class="modal__side" id="updateForm" hidden>
          <h3 class="modal__subtitle">Renovar Plan</h3>
          <form class="form" id="updateUserForm">
            <div class="form__row">
              <label class="form__label" for="Plan">Plan</label>
              <select class="form__control" id="Plan" name="Plan" required>
                <option value="">Selecciona…</option>
                <!-- PLAN Se llena por codigo -->
              </select>
            </div>

            <div class="form__row">
              <label class="form__label" for="Monto">Monto de pago</label>
              <input class="form__control" id="Monto" name="Monto" type="number" step="0.01" min="0" />
            </div>

            <div class="form__row">
              <label class="form__label" for="Dias_de_Gracia">Días de gracia</label>
              <input class="form__control" id="Dias_de_Gracia" name="Dias_de_Gracia" type="number" step="1" min="0" />
            </div>

            <div class="form__row">
              <label class="form__label" for="Medio_de_pago">Método de pago</label>
              <select class="form__control" id="Medio_de_pago" name="Medio_de_pago">
                <option value="">Selecciona…</option>
                <!-- METODO DE PAGO Se llena por codigo -->
              </select>
            </div>

            <div class="form__row">
              <label class="form__label" for="Estado">Estado de pago</label>
              <select class="form__control" id="PaymentStatus" name="PaymentStatus" required>
                <option value="">Selecciona…</option>
                <!-- ESTADO PAGO Se llena por codigo -->
              </select>
            </div>

            <!-- CODIGO DE PAREJA -->

            <div class="form__row" id="partner-row" style="display:none;">
              <label class="form__label" for="partner-code">Código de ingreso de pareja a vincular</label>
              <input class="form__control" id="partner-code" name="partner-code" type="text"
                placeholder="Código de ingreso de la pareja" />
            </div>


            <div class="form__actions">
              <button class="btn btn--secondary" type="button" id="btnCancelForm">
                Cancelar
              </button>
              <button class="btn btn--primary" type="submit">
                Guardar cambios
              </button>
            </div>
          </form>
        </aside>

        <!-- Formulario para actualizar campos individuales-->
        <aside class="modal__side" id="edit-single-form-aside" hidden>
          <h3 class="modal__subtitle" id="edit-single-form-title">
            Actualizar
          </h3>
          <form class="form" id="edit-single-form">
            <!-- Se llena por codigo -->
            <div class="form__actions">
              <button class="btn btn--secondary" type="button" id="btnCancelForm-single">
                Cancelar
              </button>
              <button class="btn btn--primary" type="submit">
                Guardar cambios
              </button>
            </div>
          </form>
        </aside>
      </div>
    </div>
  </div>

  <!-- Loader modal -->
  <div class="modal" id="loaderModal" aria-hidden="true" role="alert" aria-modal="true">
    <div class="modal__overlay"></div>
    <div class="modal__dialog card loader__dialog">
      <div class="loader__spinner"></div>
      <p class="loader__text">Procesando...</p>
    </div>
  </div>

  <!-- contenedor raíz para toasts -->
  <div id="toast" class="toast" aria-live="assertive" aria-atomic="true"></div>

  <!-- Submodal (mobile): Formulario sobre la ficha -->
  <div class="modal modal--child" id="userSubModal" aria-hidden="true" role="dialog" aria-modal="true"
    aria-labelledby="userSubModalTitle">
    <div class="modal__overlay" data-close-sub></div>
    <div class="modal__dialog card submodal__dialog" role="document">
      <header class="modal__header submodal__header">
        <h3 class="modal__title" id="userSubModalTitle">Editar</h3>
        <button class="modal__close" type="button" aria-label="Cerrar" data-close-sub>
          ✕
        </button>
      </header>
      <div class="modal__body submodal__body">
        <div id="subModalContent"></div>
      </div>
    </div>
  </div>
<script src="/public/src/utils/dynamic-forms.js"></script>
  <script src="/public/src/utils/utils.js"></script>
  <script src="/public/src/session/session_manager.js" type="module"></script>
  <script defer src="/public/src/shared/sidebar.js"></script>

  <script type="module">
    import { ensureSessionOrRedirect } from "/public/src/session/session_manager.js";
    window.SessionManager = { ensureSessionOrRedirect };
    window.dispatchEvent(new Event("session-ready"));
  </script>
  <script src="/public/src/api/api.js" defer></script>
  <script src="/public/src/notificaciones/notificaciones.js"></script>
  <script src="/public/src/env.js"></script>
  <script src="/public/src/load_dynamic_fields.js"></script>
  <script src="/public/src/submodal.js"></script>
  <script src="/public/src/update-single-form.js"></script>
  <script src="/public/src/pagination.js"></script>
  <script src="/public/src/update_user.js"></script>
  <script src="/public/src/spinner.js"></script>
  <script src="/public/src/error_toast.js"></script>
  <script src="/public/src/code.js"></script>
  <script src="/public/src/modal.js"></script>
  <script src="/public/src/registrar_Ingreso.js"></script>

    
</body>

</html>
